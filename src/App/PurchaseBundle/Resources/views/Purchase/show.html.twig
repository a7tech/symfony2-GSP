{% extends 'AppPurchaseBundle:Purchase:layout.html.twig' %}

{% set nav_title = 'Order overview' %}
{% set suite_label = 'suite'|trans({}, 'Address')~':' %}

{% block actions_main %}
    <div class="col-md-12 invoice">
        <div class="row">
            <div class="col-md-4 invoice-center">
                {% if entity.accountProfile.images|length>0 %}
                    {{ entity.accountProfile.images[0].image|vlabs_filter('resize', {'width': 100, 'height': 70})|vlabs_media('image') }}
                {% endif %}
                <br/>
                <p>logo enterprise / company logo</p>
            </div>
            <div class="col-md-4 invoice-center"><strong>{% if entity.isDraft %}DRAFT{% else %}ORDER{% endif %} <br/> {{ entity.creationDate|date(date_format) }}</strong></div>
            <div class="col-md-4 invoice-center">
                <strong>ID {{ entity.id }}</strong></br>
                <strong>{{ entity.editDate|date(date_format) }}</strong>
                <p>date de vente / date of sale </p>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 invoice-block">
                <dl class="dl-horizontal">
                    <dt>Enterprise / Company:</dt>
                    <dd>{{ entity.accountProfile }}</dd>
                    <dt>RBQ:</dt>
                    <dd>{{ entity.accountProfile.rbq }}</dd>
                    <dt>Adresse / Address:</dt>
                    <dd>{% set vendor_billing_address = entity.accountProfile.billingAddress %}{{ vendor_billing_address is not null ? vendor_billing_address.formatted(suite_label)|raw : '-' }}</dd>
                </dl>
            </div>
            <div class="col-md-6 invoice-block">
                <dl class="dl-horizontal">
                    <dt>Enterprise / Company:</dt>
                    <dd>{{ entity.supplier }}</dd>
                    <dt>Adresse / Address:</dt>
                    <dd>{% set supplier_billing_address = entity.supplier.billingAddress %}{{ supplier_billing_address is not null ? supplier_billing_address.formatted(suite_label)|raw : '-' }}</dd>
                </dl>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 invoice-product">
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>Product ID</th>
                            <th>Image</th>
                            <th>MPN/SKU #</th>
                            <th>Barcode</th>
                            <th>Brand</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Total</th>
                            <th>Taxes</th>
                            <th>Total amount</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% set total = 0 %}
                    {% for item in entity.items  %}
                        {% set product = item.product %}
                        {% set productTotal = item.netTotal %}
                        {% set taxes = item.taxesTotal(productTotal) %}
                        {% set productTotalAmount = productTotal + taxes %}
                        <tr class='collection-row'>
                            <td class="product-id">{{ product is not null ? product.id : '' }}</td>
                            <td class="product-image">
                                {% if product is not null %}
                                    {% set images = product.product.images %}
                                    {% if images|length > 0  %}<img src="/{{ images[0].image.path  }}" width="50">{% else %}-{% endif %}
                                {% endif %}
                            </td>
                            <td class="product-code">{{ product is not null ? product.product.productCode : '' }}</td>
                            <td class="product-barcode">
                                {% if product is not null %}
                                    {% for barcode in product.product.barcodes %}{{ barcode }}{% if not loop.last %},{% endif %}{% endfor %}
                                {% endif %}
                            </td>
                            <td class="product-brand">{{ product is not null ? product.product.brandGroup : '' }}</td>
                            <td class="product-title">{{ product is not null ? product.product.title : '' }}</td>
                            <td class="product-categories">
                                {% if product is not null %}
                                    {% for category in product.product.categories %}{{ category }}{% if not loop.last %},{% endif %}{% endfor %}
                                {% endif %}
                            </td>
                            <td class="number">{{ item.quantity|number_format(2) }}</td>
                            <td class="number">{{ item.price|number_format(2) }}</td>
                            <td class="number">{{ productTotal|number_format(2) }}</td>
                            <td class="number">{{ taxes|number_format(2) }}</td>
                            <td class="number">{{ productTotalAmount|number_format(2) }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row">



            <table class="table table-bordered table-striped">
                <tr>
                    <th>Total Ã  payer hors taxes / Total before taxes</th>
                    <td class="number">{{ entity.netTotal|number_format(2) }}</td>
                </tr>
                {% set taxes = entity.taxesTotals %}
                {% for tax in entity.accountProfile.taxation %}
                    <tr>
                        <th>Tax {{ tax.taxType.name }} {{ tax.taxType.rate*100 }}% ({{ tax.number }})</th>
                        <td class="number">{{ taxes[tax.id]|number_format(2) }}</td>
                    </tr>
                {% endfor %}
                <tr>
                    <th>Total taxes</th>
                    <td class="number">{{ taxes.total|number_format(2) }}</td>
                </tr>
                <tr>
                    <th>Total amount</th>
                    <td class="number">{{ entity.total|number_format(2) }}</td>
                </tr>
            </table>

            {% if not entity.isDraft %}
                <div class="invoice-block">
                    <strong>Payments</strong>
                    <form method="post">
                        {{ form_widget(form) }}

                        {% set paid = entity.paid %}
                        <table class="table" id="payment-summary" data-total="{{ entity.total }}">
                            <tbody>
                            <tr>
                                <td>Total amount</td>
                                <td class="number">{{ entity.total|number_format(2) }}</td>
                            </tr>
                            <tr>
                                <td>Paid</td>
                                <td class="number total-paid">{{ paid|number_format(2) }}</td>
                            </tr>
                            <tr>
                                <td>Due</td>
                                <td class="number due-total">{{ (entity.total - paid)|number_format(2) }}</td>
                            </tr>
                            </tbody>
                        </table>

                        <input type="submit" class="btn btn-primary" value="Save">
                    </form>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block user_js %}
    {{ parent() }}
    {% if not entity.isDraft %}
        <script src="{{ asset('bundles/appform/form_admin.js') }}" type="text/javascript"></script>
        <script src="{{ asset('js/jquery/plugins/jquery.dotimeout.js') }}" type="text/javascript"></script>
        <script src="{{ asset('bundles/appcore/js/payments-calculation.js') }}" type="text/javascript"></script>
        <script src="{{ asset('bundles/apppurchase/js/purchase-show.js') }}" type="text/javascript"></script>
        <script>
            jQuery(function($) {
                Admin.setup_collections(document);
            });
        </script>
    {% endif %}
{% endblock %}
